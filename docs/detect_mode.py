"""Модуль определения режима работы агента по содержимому сообщения."""

from enum import Enum


class Mode(Enum):
    """Режимы работы агента."""
    LECTURE = "lecture"
    CONSULTATION = "consultation"
    CRISIS = "crisis"
    DEFAULT = "default"


def detect_mode(text: str) -> Mode:
    """
    Определяет режим работы агента по содержимому сообщения.
    
    Приоритет: CRISIS > CONSULTATION > LECTURE > DEFAULT
    
    Args:
        text: Текст сообщения пользователя
    
    Returns:
        Mode: Один из режимов (CRISIS, CONSULTATION, LECTURE, DEFAULT)
    """
    normalized = text.lower()
    
    # 1. Кризис – самый высокий приоритет
    crisis_triggers = [
        "не хочу жить", "хочу умереть", "нет смысла жить",
        "убью себя", "поврежу себя", "порежу себя",
        "голоса в голове", "меня преследуют", "слышу голоса",
        "не контролирую себя", "срочно помогите",
        "очень плохо, не справляюсь"
    ]
    
    for phrase in crisis_triggers:
        if phrase in normalized:
            return Mode.CRISIS
    
    # 2. Консультация / кейсы
    consultation_triggers = [
        "есть пациент", "кейс:", "случай из практики",
        "женщина ", "мужчина ", "подросток ", "ребенок ", "ребёнок ",
        "история болезни", "анамнез",
        "как построить план реабилитации",
        "как можно построить план реабилитации",
        "как лучше реабилитировать"
    ]
    
    for phrase in consultation_triggers:
        if phrase in normalized:
            return Mode.CONSULTATION
    
    # 3. Лекция / учебные материалы
    lecture_triggers = [
        "сделай конспект по", "подготовь конспект по",
        "подготовь к зачёту по", "подготовь к зачету по",
        "подготовь к экзамену по", "план лекции по",
        "план презентации по", "объясни тему",
        "структурируй материал по",
        "сделай учебный материал по", "сделай слайды по"
    ]
    
    for phrase in lecture_triggers:
        if phrase in normalized:
            return Mode.LECTURE
    
    # 4. Обычный режим
    return Mode.DEFAULT


# Модификаторы промпта для каждого режима
MODE_MODIFIERS = {
    Mode.LECTURE: "Режим: ЛЕКЦИЯ. Дай развёрнутый учебный ответ с подзаголовками и структурой.",
    Mode.CONSULTATION: "Режим: КОНСУЛЬТАЦИЯ. Разбери кейс как учебный пример, без постановки диагноза.",
    Mode.CRISIS: "Режим: КРИЗИС. Оцени безопасность и выполни маршрутизацию к очной помощи.",
    Mode.DEFAULT: "Режим: ОБЫЧНЫЙ. Дай краткий структурированный ответ на вопрос."
}


if __name__ == "__main__":
    # Примеры использования
    test_messages = [
        "Подготовь конспект по реабилитации при депрессии",
        "Есть пациент 45 лет с паническими атаками",
        "Не хочу жить, всё плохо",
        "Чем отличается ГТР от панического расстройства?"
    ]
    
    for msg in test_messages:
        mode = detect_mode(msg)
        print(f"Сообщение: {msg}")
        print(f"Режим: {mode.value}")
        print(f"Модификатор: {MODE_MODIFIERS[mode]}")
        print("-" * 50)
